# KeyCloak #

In early steps, we did use an sample authenticate site to do user authentication. Now we want to switch it to use KeyCloak as user authentication provider. 

## Step 1 : Create KeyCloak Service ##

KeyCloak is opensource project. You can get it from: [KeyCloak Org](http://www.keycloak.org/)

### Download KeyCloak ###

As demo today I use KeyCloak 3.1.0.Final version. Download standalone server distribution.

### Update KeyCloak Configure ###

KeyCloak by default it listen to port 8080, since we already run our demo service at this port, so we need to change the KeyCloak to a different port. 

(Exception: If you use different machine to run KeyCloak, then you can ignore this step.)

After unpack the KeyCloak zip file, go to folder 'keycloak-3.1.0.Final/standalone/configuration', edit standalone.xml,
change the http port from '8080' to '9080'.

```aidl

<socket-binding name="http" port="${jboss.http.port:9080}"/>

```

### Use actual domain name ###

In this demo, I would use 'hosts' file override to give a DNS name 'www.ecom.net'. 
In actually work, you should use your domain name.

Edit '/etc/hosts', add line:

`
127.0.0.1       www.ecom.net
`

### Launch and  KeyCloak Service ###

In 'keycloak-3.1.0.Final' folder, run command line to start KeyCloak Service:
```aidl
./bin/standalone.sh -c standalone.xml

```

### Login to KeyCloak Admin ###

Open: [http://ecom.net:9080/auth],

You will be asked to create admin account, then login as admin.

## Step 2: Create new realm ##

Note: You can use import realm from file [docs/asset/ecom-net.json](/docs/asset/ecom-net.json)

OR do following steps:

- Create a realm: ecom-net
- In ECom-net realm, create a new client: ecom-net-site. Set the root url to http://www.ecom.net:8080. Rest setting use default value.
- In ECom-net realm, create a new client: ecom-net-api, Set 'Access Type' to 'bearer-only'. Rest setting use default value.


NOTE: 
- since the Ember project will be targeted to be run under Scalatra Web App, which is in port of 8080, so we make the client Root URL port at 8080.
- When you run test at `ember s` it will start at port 4200. KeyCloak will not accept it as return URL.
- To resolve it, we can change ember cli port to 8080.

## Step 3: Use KeyCloak in Ember ##

There are a couple ways to integrate the KeyCloak into EmberJs.
- Use keyCloak provided JavaScrip Adapter: [keycloak.js](https://keycloak.gitbooks.io/documentation/securing_apps/topics/oidc/javascript-adapter.html)
- Use [ember-keycloak-auth](https://github.com/JFTechnology/ember-keycloak-auth)
- Use [ember-cli-keycloak](https://www.pincer.io/npm/libraries/ember-cli-keycloak)
- Use ember simple auth + keycloak.js

In this session, I will try KeyCloak.js and ember-keycloak-auth.
 
### Step 3.1: Try keycloak.js ###

To demo integration keycloak.js, let's start with a blank new EmberJs project.

- Create a new ember project name : ember-sale
```aidl

$ ember new ember-sale

```
  After it was ready, change the app rootURL to '/sale'. 
  
  Change the file: .ember-cli to add port as 8080.

```aidl
{
  /**
    Ember CLI sends analytics information by default. The data is completely
    anonymous, but there are times when you might want to disable this behavior.

    Setting `disableAnalytics` to true will prevent any data from being sent.
  */
  "disableAnalytics": false,
  "port": 8080
}

```

  Then run 

  ```aidl
  ember build
  ember server
  ```
  
   Make sure it works.  
  
  
- Add keycloak : 

Follow by the KeyCloak JavaScrip Adapter Document, add javascrip and init the keycloak in index.html file.

Insert following code in index.html

```

    <script src="http://www.ecom.net:9080/auth/js/keycloak.js"></script>

    <script>
      $( document ).ready(function() {

        var keycloak = Keycloak();

        keycloak.init({ onLoad: 'login-required' }).success(function(authenticated) {
          alert(authenticated ? 'authenticated' : 'not authenticated');
        }).error(function() {
          alert('failed to initialize');
        });
      });

    </script>

```

- Create keycloak.json in the ember-sale/public folder.

// file: keycloak.json (This file can be get from keycloak site, client of 'ecom-net-site' installation.)
```aidl

{
  "realm": "ecom-net",
  "auth-server-url": "http://www.ecom.net:9080/auth",
  "ssl-required": "external",
  "resource": "ecom-net-site",
  "public-client": true
}

```

- Start ember server, then open browser at URL "http://www.ecom.net:8080/sale/", you will see you are landing on keycloak sign in page.
- Since you don't have a user yet, so go register it. After you register it and login, you will see ember welcome page!

- The above setting is require the user login to keycloak on home page. If we don't want to force user login, then we can update index.html:

Change
```
keycloak.init({ onLoad: 'login-required' })
```

to 
```
keycloak.init({ onLoad: 'check-sso' })
```

### Step 3.2: Try ember keycloak auth ###

We will update the ember-user to use ember-keycloak-auth.

- In ember-user, install ember-keycloak-auth

```text
$ cd ember-user
$ ember install ember-keycloak-auth
```

- Init keycloak in ember-user/app/routes/application.js route. (Note: remove old code for ember-simple-auth in this file as well.)

```text
// routes/application.js
import Ember from 'ember';

export default Ember.Route.extend( {
  session: Ember.inject.service('keycloak-session'),

  beforeModel: function () {

    this._super(...arguments);

    var session = this.get('session');

    // Keycloak constructor arguments as described in the keycloak documentation.
    var options = {
      'url': 'http://www.ecom.net:9080/auth',
      'realm': 'ecom-net',
      'clientId': 'ecom-net-site'
    };

    // this will result in a newly constructed keycloak object
    session.installKeycloak(options);

    // set any keycloak init parameters where defaults need to be overidden
    session.set('responseMode', 'fragment');
    session.set('onLoad', 'login-required');

    // finally init the service and return promise to pause router.
    return session.initKeycloak();

  }
});

```

- Update the .ember-cli file, set the server port to 8080 for testing purpose.

- Build ember-user and start ember server by `ember s`

- Visit  [http://www.ecom.net:8080/user/](http://www.ecom.net:8080/user/). You should see the keycloak login form.

- After you login to keycloak, it will redirect back to ember-user home page (which in current it is old login form. We don't need it and will remove it later.)

- Remove the ember-simple-auth as for now we don't need it.

```text
npm uninstall ember-simple-auth --save-dev

rm ember-user/app/authenticators/user.js
rm ember-user/app/components/login-form.js
rm ember-user/app/routes/login.js
rm ember-user/app/session-stores/application.js
rm ember-user/app/templates/components/login-form.hbs
rm ember-user/app/templates/login.hbs

```

Update controllers/application.js
```text
import Ember from 'ember';

export default Ember.Controller.extend({
  session: Ember.inject.service('keycloak-session'),
  actions: {
    login: function () {
      this.get('session').login('http://www.ecom.net:8080/user/');
    },

    logout: function () {
      this.get('session').logout('http://www.ecom.net:8080/user/');
    }
  }
});

```

Update for the application.hbs template
```text

<div class="body">
  {{#if session.authenticated}}
    <button {{action 'logout'}}>Logout</button>
  <div class="ui container">
    {{outlet}}
  </div>
  {{else}}
    <button {{action 'login'}}>login</button>
  {{/if}}
</div>

```

Option: 

- You can chanage the routes/application.js, set the `session.set('onLoad', 'login-required');` to  `session.set('onLoad', 'check-sso');`. In this case, user can stay on logout without redirect to keycloak login page. Only when the page was indicated to be proected, then it will ask user to login.
- Update the config environment.js, set `locationType: 'auto',`. When keycloak logged in, it will redirect back to the URL.
- In controllers/application.js, save the current URL.
- Add a component 'keycloak-session-link.js' to show the login/logout link, taking care of login/logout action.

These are regular Ember work, so please reference to the code to see how it was made.

## Step 4: Sharing the keycloak login token the ember projects ## 

Since we are going to share the keycloak login token, we need run it in Scalatra service. To do it, first revert the ember-user port to 4202 (in file ember-user/.ember-cli).


### Step 4.1 clean ember-simple-auth from ember-admin ###

- Clean ember-simple-auth (see previous section on how to do it.)
- Update the config/environment.js, set: `locationType: 'auto',`
- Update the routes/application.js, remove ember-simple-auth related code, but keep login/logout action.
- Update the controllers/application.js, remove `session: Ember.inject.service('session')`

After above change, run `ember s` to test the server. Make sure it still working. (but not able to login).

### Step 4.2 enable ember-keycloak-auth in ember-admin ###

- Run `ember install ember-keycloak-auth` to install module at ember-admin project.
- Init keycloak in routes/application.js
```text
import Ember from 'ember';
export default Ember.Route.extend( {
  session: Ember.inject.service('keycloak-session'),

  beforeModel: function () {

    this._super(...arguments);

    var session = this.get('session');

    // Keycloak constructor arguments as described in the keycloak documentation.
    var options = {
      'url': 'http://www.ecom.net:9080/auth',
      'realm': 'ecom-net',
      'clientId': 'ecom-net-site'
    };

    // this will result in a newly constructed keycloak object
    session.installKeycloak(options);

    // set any keycloak init parameters where defaults need to be overidden
    session.set('responseMode', 'fragment');
    session.set('onLoad', 'login-required'); // login-required or check-sso

    // finally init the service and return promise to pause router.
    return session.initKeycloak();

  },

  actions: {
    logout: function() {
      this.get('session').logout('http://www.ecom.net:8080/admin/');
    }
  }

});

```

In application.hbs, since it will always login, so we only need a logout button:

change: 
```text
    {{#if session.isAuthenticated}}
      <button {{action 'logout'}}>Logout</button>
    {{else}}
      <button {{action 'login'}}>Login</button>
    {{/if}}
```
to:
```text

    <button {{action 'logout'}}>Logout</button>

```

Please note: It change : `session.set('onLoad', 'login-required');` to force login in admin site.

To test the keycloak, we need to run it in port 8080, so let's deploy it to Scalatra and test in there.

- Run Scalatra service: in tiny-legend-web folder, run './sbt ~jetty:start' and keep the service running. (If you got address in used error, try to change the debug port 5005 to other number at 'build.sbt')

- Each time if ember-admin code was changed, rebuild it by run `ember build`, it will updated to Scalatra service and be auto-reloaded. 

- Visit http://www.ecom.net:8080/admin/, you should be redirect to keycloak login page. After logged in, you will be redirect back to /admin.

- Open http://www.ecom.net:8080/user/, you can see you are still in logged in status. Since two ember sites are using same keycloak setting, the authentication result was shared in keycloak url at http://www.ecom.net:9080/auth.
 
 Note:
 
 There are some issues when redirect to sub route when it logged in from keycloak. We will resolve this issue later.
  
  
 ## Step 5: update ember-app to use keycloak ##
 
 Since the ember-app has a API call, it has a little more thing to be take care. We will do it in next section.
  For now, you can try to upgrade it to keycloak (UI login page). Have fun :)

