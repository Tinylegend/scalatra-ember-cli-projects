# Ember Backend API #

In this topic, we will have Ember call backend api which we made in Scalatra Service.

## Ember UI shows products ##

The API in backend service /api/products will return all products in list. We will show it in Ember UI home page.

First we will update the home page template. Add index route to show the page.
```aidl
$ cd ember-app
$ ember g route index
$ ember g model product
```

As above command will generate index route at app/routes/index.js and the template at app/templates/index.hbs.

Also we will create product model at app/models/product.js which will match to the JSON API return.

```aidl
$ ember g route index
installing route
  create app/routes/index.js
  create app/templates/index.hbs
installing route-test
  create tests/unit/routes/index-test.js
  
$ ember g model product
installing model
  create app/models/product.js
installing model-test
  create tests/unit/models/product-test.js
  ```

Give the model some attributes which match to the JSON api return data:
```aidl
// app/models/product.js

import DS from 'ember-data';

export default DS.Model.extend({
  title: DS.attr('string'),
  detail: DS.attr('string'),
  image: DS.attr('string')
});

```

From index.js route, we want it to query data from Scalatra API, we will use ember data store to do it: (So far it is ember default standard JSON.API specification.)
```aidl
// app/routes/index.js
import Ember from 'ember';

export default Ember.Route.extend({
  model() {
    return this.get('store').findAll('product');
  }
});

```

Since our Scalatra API was hook up at /api/products, so we need a adapter to tell ember how to connect it. Let's create an ember adapter:
```aidl
$ ember g adapter application

installing adapter
  create app/adapters/application.js
installing adapter-test
  create tests/unit/adapters/application-test.js
```

By default, ember will use '/' to call backend api. But our backend service is under '/api'. 
We can update it by updating the app/adapters/application.js to tell it get products under /api:
```aidl
// app/adapters/application.js
import RESTAdapter from 'ember-data/adapters/rest';

export default RESTAdapter.extend({
  namespace: 'api'
});
```

Assume we got products data was returned. We want to show it in index.hbs:

Update file: app/templates/index.hbs
```aidl
{{#each model as |product|}}

<div class="ui card">
    <div class="image dimmable">
        <div class="ui blurring inverted dimmer">
            <div class="content">
                <div class="center">
                    <div class="ui teal button">Product</div>
                </div>
            </div>
        </div>
        <img src="{{product.image}}">
    </div>
    <div class="content">
        <div class="header">{{product.title}}</div>
        <div class="meta">
            <a class="group">Meta</a>
        </div>
        <div class="description">{{product.detail}}</div>
    </div>
    <div class="extra content">
        <a class="right floated created">Arbitrary</a>
        <a class="friends">
            Arbitrary</a>
    </div>
</div>

{{/each}}
```

At this point, we don't want to use ember default welcome page. so in app/templates/application.hbs, **remove** following lines:
```aidl
{{!-- The following component displays Ember's default welcome message. --}}
{{welcome-page}}
{{!-- Feel free to remove this! --}}

```

Sound every thing is OK, let's run it.

Oops, I got error:
```aidl
Error while processing route: index Unexpected token L in JSON at position 0 SyntaxError: Unexpected token L in JSON at position 0
    at parse (<anonymous>)
    at ajaxConvert (http://localhost:8080/app/assets/vendor.js:9072:19)
    at done (http://localhost:8080/app/assets/vendor.js:9540:15)
    at XMLHttpRequest.<anonymous> (http://localhost:8080/app/assets/vendor.js:9832:9)
```

What was happened? 

It looks like the return JSON was received, but it was not understood by ember. Why?

After reading ember document and do online search, I got answer. By default ember use [JSON API spec](http://jsonapi.org/format/) to deal with the api return data. 
In the 'api/products' the return content type was set to 'application/vnd.api+json', 
but actually return data from the api was generated by 'JacksonJsonSupport' which does not meet the JSON API SPEC. Try to change return type to 'application/json', it does not work as well.

Work around: We could make 'api/' return JSON string meet the JSON API SPEC. But for now we can do other way. 
For more information about how ember handle JSON API data, we may do it in advance topic later. 

For now we will create a serializer to handle the JSON string. 
```aidl
$ ember g serializer application
installing serializer
  create app/serializers/application.js
installing serializer-test
  create tests/unit/serializers/application-test.js
```

Udpate the app/serializers/application.js:
```aidl
//app/serializers/application.js

import Ember from 'ember';
import JSONSerializer from 'ember-data/serializers/json';

export default JSONSerializer.extend({
  keyForAttribute(key) {
    return Ember.String.decamelize(key);
  }
});

```

Now let's rerun the application, bingo! we see the two products are listed in the home page!